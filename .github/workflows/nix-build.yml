name: NixOS Package Build

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number'
        required: true
        type: string
        default: '1.0.3-1'
  release:
    types: [published]

jobs:
  build-nix-package:
    runs-on: ubuntu-latest
    name: Build NixOS Package
    steps:
      - uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build libgtk-3-dev
      
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.19.3'
          channel: 'stable'
          cache: true

      - name: Build Flutter App
        run: |
          flutter config --enable-linux-desktop
          flutter pub get
          flutter build linux --release

      - name: Create NixOS Package
        run: |
          VERSION="${{ github.event.inputs.version }}"
          echo "Using version: $VERSION"
          
          # Create structure
          mkdir -p nixos/app
          mkdir -p nixos/bin
          
          # Copy binaries and create wrapper
          cp -r build/linux/x64/release/bundle/* nixos/app/
          cat > nixos/bin/rateme << 'EOF'
          #!/bin/sh
          exec /run/current-system/sw/bin/rateme "$@"
          EOF
          chmod +x nixos/bin/rateme
          
          # Create installation guide
          cat > nixos/README.md << 'EOF'
          # Rate Me! for NixOS

          ## Quick Installation

          ```bash
          # Install globally
          sudo nix-env -i -f default.nix

          # Or install for current user only
          nix-env -i -f default.nix
          ```

          ## Testing Before Installation

          ```bash
          # Build without installing
          nix-build
          
          # Run the built package
          ./result/bin/rateme
          ```

          ## Development

          For development, use the provided shell.nix:
          ```bash
          nix-shell
          ```

          ## Uninstallation

          ```bash
          nix-env -e rateme
          ```
          EOF
          
          # Create tarball with all components
          cd nixos
          tar -czf ../rateme-nixos-$VERSION.tar.gz {app,bin,README.md,default.nix,shell.nix}
          cd ..
          
          echo "Created package archive with:"
          tar -tvf rateme-nixos-$VERSION.tar.gz

      - name: Upload NixOS Package
        uses: actions/upload-artifact@v4
        with:
          name: rateme-nixos-package
          path: rateme-nixos-*.tar.gz

      - name: Add to Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v1
        with:
          files: rateme-nixos-*.tar.gz
