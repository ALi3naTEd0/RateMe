name: Linux Build

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build libgtk-3-dev
          sudo apt-get install -y rpm
          wget -O appimagetool "https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage"
          chmod +x appimagetool
          sudo mv appimagetool /usr/local/bin/

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.19.3'
          channel: 'stable'
          cache: true

      - name: Build Linux
        run: |
          flutter config --enable-linux-desktop
          flutter pub get
          flutter build linux --release

      - name: Create DEB Package
        run: |
          mkdir -p debian/DEBIAN
          mkdir -p debian/usr/local/bin
          mkdir -p debian/usr/share/applications
          mkdir -p debian/usr/share/icons/hicolor/256x256/apps
          
          cp -r build/linux/x64/release/bundle/* debian/usr/local/bin/
          
          cat > debian/DEBIAN/control << EOF
          Package: rateme
          Version: 1.0.0
          Architecture: amd64
          Maintainer: Your Name <your.email@example.com>
          Description: Rate Me Application
           A cross-platform rate calculator application.
          EOF
          
          cat > debian/usr/share/applications/rateme.desktop << EOF
          [Desktop Entry]
          Name=Rate Me
          Exec=/usr/local/bin/rate_me
          Icon=rateme
          Type=Application
          Categories=Utility;
          EOF
          
          cp assets/icon.png debian/usr/share/icons/hicolor/256x256/apps/rateme.png
          
          dpkg-deb --build debian
          mv debian.deb RateMe.deb

      - name: Create RPM Package
        run: |
          mkdir -p ~/rpmbuild/{SPECS,BUILD,RPMS,SOURCES}
          cp -r build/linux/x64/release/bundle/* ~/rpmbuild/BUILD/
          
          cat > ~/rpmbuild/SPECS/rateme.spec << EOF
          Name: rateme
          Version: 1.0.0
          Release: 1
          Summary: Rate Me Application
          License: Proprietary
          
          %description
          A cross-platform rate calculator application.
          
          %install
          mkdir -p %{buildroot}/usr/local/bin
          cp -r . %{buildroot}/usr/local/bin/
          
          %files
          /usr/local/bin/*
          EOF
          
          rpmbuild -bb ~/rpmbuild/SPECS/rateme.spec
          cp ~/rpmbuild/RPMS/x86_64/rateme-1.0.0-1.x86_64.rpm ./RateMe.rpm

      - name: Create AppImage
        run: |
          mkdir -p AppDir
          cp -r build/linux/x64/release/bundle/* AppDir/
          cp assets/icon.png AppDir/
          
          cat > AppDir/AppRun << EOF
          #!/bin/sh
          cd "\$(dirname "\$0")"
          exec ./rate_me
          EOF
          
          chmod +x AppDir/AppRun
          
          cat > AppDir/rateme.desktop << EOF
          [Desktop Entry]
          Name=Rate Me
          Exec=AppRun
          Icon=icon
          Type=Application
          Categories=Utility;
          EOF
          
          appimagetool AppDir RateMe.AppImage

      - name: Upload Packages
        uses: actions/upload-artifact@v4
        with:
          name: RateMe-Linux-Packages
          path: |
            RateMe.deb
            RateMe.rpm
            RateMe.AppImage
